<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FairPrime Market - Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header') %>

  <div class="container mt-4">
    <h2 class="text-center mb-4">Admin Dashboard</h2>

    <% const activeTab = typeof tab !== 'undefined' ? tab : 'products'; %>

    <!-- NAV TABS -->
    <ul class="nav nav-tabs mb-3" id="adminTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= activeTab === 'products' ? 'active' : '' %>"
                id="products-tab" data-bs-toggle="tab" data-bs-target="#products"
                type="button" role="tab">
          Products
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= activeTab === 'users' ? 'active' : '' %>"
                id="users-tab" data-bs-toggle="tab" data-bs-target="#users"
                type="button" role="tab">
          Users
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= activeTab === 'orders' ? 'active' : '' %>"
                id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders"
                type="button" role="tab">
          Orders
        </button>
      </li>
    </ul>

    <div class="tab-content" id="adminTabContent">

      <!-- PRODUCTS TAB -->
      <div class="tab-pane fade <%= activeTab === 'products' ? 'show active' : '' %>"
           id="products" role="tabpanel">
        <div class="mb-3 text-end">
          <a href="/addProduct" class="btn btn-primary">Add New Product</a>
        </div>
        <table class="table table-bordered text-center">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Category</th>
              <th>Tags</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% (products || []).forEach(p => { %>
              <tr>
                <td><%= p.id %></td>
                <td><%= p.productName %> <% if (String(p.isActive) === '0') { %><span class="badge bg-secondary ms-1">Inactive</span><% } %></td>
                <td><%= p.category || '-' %></td>
                <td><%= p.tags || '-' %></td>
                <td>$<%= Number(p.price || 0).toFixed(2) %></td>
                <td><%= p.quantity %></td>
                <td>
                  <a href="/editProduct/<%= p.id %>" class="btn btn-warning btn-sm">Edit</a>
                  <form action="/deleteProduct/<%= p.id %>" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger btn-sm"
                            onclick="return confirm('Delete this product?')">
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- USERS TAB -->
      <div class="tab-pane fade <%= activeTab === 'users' ? 'show active' : '' %>"
           id="users" role="tabpanel">
        <div class="mb-3 text-end">
          <a href="/users/add" class="btn btn-primary">Add New User</a>
        </div>
        <table class="table table-bordered text-center">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Loyalty Points</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% (users || []).forEach(u => { %>
              <tr>
                <td><%= u.id %></td>
                <td><%= u.username %></td>
                <td><%= u.email %></td>
                <td><%= u.role %></td>
                <td><%= u.loyaltyPoints || 0 %></td>
                <td>
                  <a href="/users/edit/<%= u.id %>" class="btn btn-warning btn-sm">Edit</a>
                  <form action="/users/delete/<%= u.id %>" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger btn-sm"
                            onclick="return confirm('Delete this user?')">
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- ORDERS TAB -->
      <div class="tab-pane fade <%= activeTab === 'orders' ? 'show active' : '' %>"
           id="orders" role="tabpanel">
        <table class="table table-bordered text-center">
          <thead class="table-dark">
            <tr>
              <th>Order ID</th>
              <th>User ID</th>
              <th>User Name</th>
              <th>Status</th>
              <th>Total</th>
              <th>Created At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% (orders || []).forEach(o => { %>
              <tr>
                <td><%= o.id %></td>
                <td><%= o.userId %></td>
                <td><%= o.username %></td>
                <td><%= o.status %></td>
                <td>$<%= Number(o.totalAmount || o.total || 0).toFixed(2) %></td>
                <td><%= o.createdAt %></td>
                <td>
                  <!-- Update Status -->
                  <form action="/orders/updateStatus/<%= o.id %>?tab=orders"
                        method="POST"
                        class="d-inline-flex align-items-center mb-1">
                    <select name="status" class="form-select form-select-sm me-2">
                      <option value="Pending"    <%= o.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                      <option value="Processing" <%= o.status === 'Processing' ? 'selected' : '' %>>Processing</option>
                      <option value="Shipped"    <%= o.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                      <option value="Delivered"  <%= o.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                      <option value="Cancelled"  <%= o.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                    </select>
                    <button type="submit" class="btn btn-success btn-sm">Update</button>
                  </form>

                  <!-- Invoice + Delete -->
                  <div class="mt-1">
                    <a href="/invoice/<%= o.id %>" class="btn btn-primary btn-sm">Invoice</a>
                    <form action="/orders/delete/<%= o.id %>?tab=orders" method="POST" class="d-inline">
                      <button type="submit" class="btn btn-danger btn-sm"
                              onclick="return confirm('Delete this order?')">
                        Delete
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
