<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice - Order <%= order.id %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header') %>

  <main class="container my-5">
    <h2>Payment Invoice</h2>
    <p>
      Thank you for your order,
      <%= order && order.customerName ? order.customerName : 'Customer' %>!
    </p>

    <div class="mb-3">
      <p><strong>Order ID:</strong> <%= order.id %></p>
      <p><strong>Customer ID:</strong> <%= order.userId %></p>
      <p><strong>Order Date:</strong> <%= order.createdAt %></p>
      <% if (order && order.paymentMethod) { %>
        <p><strong>Payment Method:</strong> 
          <% 
            let methodDisplay = order.paymentMethod;
            if (order.paymentMethod === 'COD') methodDisplay = 'Cash on Delivery (COD)';
            else if (order.paymentMethod === 'PayPal') methodDisplay = 'PayPal';
            else if (order.paymentMethod === 'NETS') methodDisplay = 'NETS QR';
            else if (order.paymentMethod === 'Wallet') methodDisplay = 'Wallet Balance';
          %>
          <%= methodDisplay %>
        </p>
      <% } %>
      <% if (paymentCurrency && paymentCurrency !== 'SGD') { %>
        <p><strong>Payment Currency:</strong> <span style="color: #0066cc; font-weight: bold;"><%= paymentCurrency %></span></p>
      <% } %>
    </div>

    <table class="table table-bordered text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Image</th>
          <th>Product Name</th>
          <th>Quantity</th>
          <th>Unit Price</th>
          <th>Line Total</th>
        </tr>
      </thead>
      <tbody>
        <% let subtotal = 0; %>
        <% (items || []).forEach(item => { %>
          <% const lineTotal = (item.quantity || 0) * (item.price || 0); %>
          <% subtotal += lineTotal; %>
          <tr>
            <td>
              <img
                src="<%= item.image && item.image.startsWith('http') ? item.image : '/images/' + item.image %>"
                width="60"
                alt="<%= item.productName %>"
              >
            </td>
            <td><%= item.productName %></td>
            <td><%= item.quantity %></td>
            <td>$<%= Number(item.price || 0).toFixed(2) %></td>
            <td>$<%= lineTotal.toFixed(2) %></td>
          </tr>
        <% }) %>
      </tbody>
      <tfoot>
        <% 
          // First calculate the coin discount from database
          const baseTotal = subtotal * 1.09; // Original with GST
          const coinDiscount = baseTotal - (order.totalAmount || baseTotal);
          const discountedSubtotal = Math.max(0, subtotal - coinDiscount);
          const gst = discountedSubtotal * 0.09; // GST on discounted subtotal
        %>
        <tr>
          <td colspan="4" class="text-end"><strong>Subtotal</strong></td>
          <td>$<%= subtotal.toFixed(2) %></td>
        </tr>
        <% if (coinDiscount > 0.01) { %>
          <tr style="background-color: #fff3cd;">
            <td colspan="4" class="text-end"><strong style="color: #856404;">ðŸ’° Coin Discount</strong></td>
            <td><strong style="color: #856404;">-$<%= coinDiscount.toFixed(2) %></strong></td>
          </tr>
        <% } %>
        <tr>
          <td colspan="4" class="text-end"><strong>GST (9%)</strong></td>
          <td>$<%= gst.toFixed(2) %></td>
        </tr>
        <tr>
          <td colspan="4" class="text-end"><strong>Grand Total</strong></td>
          <td><strong>$<%= parseFloat(order.totalAmount || baseTotal).toFixed(2) %></strong></td>
        </tr>
        <tr>
          <td colspan="4" class="text-end text-muted">
            <small>Total in DB</small>
          </td>
          <td class="text-muted">
            <small>$<%= Number(order.totalAmount || 0).toFixed(2) %></small>
          </td>
        </tr>
        <% if (paymentCurrency && paymentCurrency !== 'SGD') { %>
          <tr style="background-color: #e7f3ff;">
            <td colspan="4" class="text-end"><strong style="color: #0066cc;">Amount Paid in <%= paymentCurrency %></strong></td>
            <td><strong style="color: #0066cc;"><%= paymentCurrency %> <%= parseFloat(paidAmount).toFixed(2) %></strong></td>
          </tr>
        <% } %>
      </tfoot>
    </table>

    <a href="/admin" class="btn btn-primary">Back to Dashboard</a>
  </main>

  <%- include('partials/footer') %>
</body>
</html>
