<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FairPrime Market - Checkout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- PayPal JS SDK: replace YOUR_CLIENT_ID and currency if needed -->
  <script src="https://www.paypal.com/sdk/js?client-id=<%= process.env.PAYPAL_CLIENT_ID %>&currency=SGD"></script>
</head>
<body>
  <%- include('partials/header') %>

  <div class="container mt-4">
    <h2 class="mb-4">Checkout</h2>

    <form id="checkout-form" action="/checkout" method="POST">
      <div class="row">
        <!-- LEFT: address + delivery + payment -->
        <div class="col-md-7 mb-4">
          <div class="border rounded p-3 mb-3">
            <h5 class="mb-2">Delivery Address</h5>
            <textarea name="address" class="form-control" rows="3"
                      placeholder="Enter your delivery address"><%= user.address || '' %></textarea>
          </div>

          <div class="border rounded p-3 mb-3">
            <h5 class="mb-2">Delivery Option</h5>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="deliveryOption"
                     id="del-standard" value="standard" checked>
              <label class="form-check-label" for="del-standard">Standard (3–5 days)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="deliveryOption"
                     id="del-express" value="express">
              <label class="form-check-label" for="del-express">Express (1–2 days)</label>
            </div>
          </div>

          <div class="border rounded p-3 mb-3">
            <h5 class="mb-2">Payment Method</h5>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="paymentMethod"
                     id="pm-card" value="card" checked>
              <label class="form-check-label" for="pm-card">Credit / Debit Card</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="paymentMethod"
                     id="pm-wallet" value="wallet">
              <label class="form-check-label" for="pm-wallet">Digital Wallet (GrabPay / PayNow)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="paymentMethod"
                     id="pm-cod" value="cod">
              <label class="form-check-label" for="pm-cod">Cash on Delivery</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="paymentMethod"
                     id="pm-paypal" value="paypal">
              <label class="form-check-label" for="pm-paypal">PayPal</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="paymentMethod"
                     id="pm-nets" value="nets">
              <label class="form-check-label" for="pm-nets">NETS QR</label>
            </div>
          </div>
        </div>

        <!-- RIGHT: order summary -->
        <div class="col-md-5">
          <div class="border rounded p-3 mb-3">
            <h5 class="mb-3">Order Summary</h5>

            <ul class="list-group mb-3">
              <% cartItems.forEach(item => { %>
                <li class="list-group-item d-flex justify-content-between">
                  <span><%= item.productName %> × <%= item.quantity %></span>
                  <span>$<%= (item.price * item.quantity).toFixed(2) %></span>
                </li>
              <% }) %>
            </ul>

            <p class="d-flex justify-content-between">
              <span>Subtotal</span>
              <span>$<%= subtotal.toFixed(2) %></span>
            </p>
            <p class="d-flex justify-content-between">
              <span>GST (9%)</span>
              <span>$<%= (subtotal * 0.09).toFixed(2) %></span>
            </p>
            <hr>
            <h5 class="d-flex justify-content-between">
              <span>Total</span>
              <span id="checkout-total"
                    data-total="<%= (subtotal * 1.09).toFixed(2) %>">
                $<%= (subtotal * 1.09).toFixed(2) %>
              </span>
            </h5>

            <!-- Normal Place Order button (non-PayPal methods) -->
            <button id="place-order-btn" type="submit"
                    class="btn btn-success w-100 mt-3">
              Place Order
            </button>

            <!-- PayPal container, shown only when PayPal selected -->
            <div id="paypal-container" class="mt-3" style="display:none;">
              <div id="paypal-button-container"></div>
            </div>

            <!-- NETS QR container, shown only when NETS selected -->
            <div id="nets-container" class="mt-3" style="display:none;">
              <h5 class="mb-3">Pay with NETS QR</h5>
              <p class="text-muted mb-3">Click the button below to generate your NETS QR code</p>
              <button id="nets-btn" type="button" class="btn btn-primary w-100">Generate NETS QR Code</button>
            </div>

            <a href="/cart" class="btn btn-outline-secondary w-100 mt-2">
              Back to Cart
            </a>
          </div>
        </div>
      </div>
    </form>

    <!-- NETS form (outside main form) -->
    <form id="nets-form" action="/generateNETSQR" method="POST" style="display:none;">
      <input type="hidden" id="nets-amount" name="cartTotal" value="">
    </form>
  </div>

  <%- include('partials/footer') %>

  <script>
    const methodRadios = document.querySelectorAll('input[name="paymentMethod"]');
    const placeOrderBtn = document.getElementById('place-order-btn');
    const paypalContainer = document.getElementById('paypal-container');
    const netsContainer = document.getElementById('nets-container');
    const netsBtn = document.getElementById('nets-btn');
    const netsForm = document.getElementById('nets-form');
    const netsAmount = document.getElementById('nets-amount');
    const totalEl = document.getElementById('checkout-total');
    const totalValue = totalEl.dataset.total;

    function updatePaymentUI() {
      const selected = document.querySelector('input[name="paymentMethod"]:checked').value;
      
      // Hide all payment containers first
      placeOrderBtn.style.display = 'none';
      paypalContainer.style.display = 'none';
      netsContainer.style.display = 'none';
      
      // Show the appropriate payment method
      if (selected === 'paypal') {
        paypalContainer.style.display = 'block';
      } else if (selected === 'nets') {
        netsContainer.style.display = 'block';
        netsAmount.value = totalValue;
      } else {
        placeOrderBtn.style.display = 'block';
      }
    }

    // Handle NETS button click
    netsBtn.addEventListener('click', function(e) {
      e.preventDefault();
      netsAmount.value = totalValue;
      netsForm.submit();
    });

    methodRadios.forEach(r => r.addEventListener('change', updatePaymentUI));
    updatePaymentUI();

    // Render PayPal button – server will handle create/capture in your controller
    paypal.Buttons({
      createOrder: function (data, actions) {
        return actions.order.create({
          purchase_units: [{
            amount: { value: totalValue }
          }]
        });
      },
      onApprove: function (data, actions) {
        console.log('[CLIENT] PayPal onApprove called');
        console.log('[CLIENT] PayPal data.orderID:', data.orderID);
        return actions.order.capture().then(function (details) {
          console.log('[CLIENT] PayPal capture details:', details);
          // Call back-end to finalize the supermarket order
          console.log('[CLIENT] Sending POST to /orders/paypal-complete with paypalOrderId:', data.orderID);
          return fetch('/orders/paypal-complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paypalOrderId: data.orderID
              // You'll also send orderId once you create it in your controller
            })
          }).then(response => {
            console.log('[CLIENT] Response status:', response.status);
            if (!response.ok) {
              console.error('[CLIENT] Fetch error:', response.statusText);
              return response.json().then(err => { throw err; });
            }
            return response.json();
          }).then(data => {
            console.log('[CLIENT] Response data:', data);
            console.log('[CLIENT] Redirecting to /orders');
            window.location.href = '/orders';
          }).catch(err => {
            console.error('[CLIENT] Fetch catch error:', err);
            alert('Error completing payment: ' + (err.error || err.message || 'Unknown error'));
          });
        });
      }
    }).render('#paypal-button-container');
  </script>
</body>
</html>
